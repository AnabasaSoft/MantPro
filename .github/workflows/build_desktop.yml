name: Construir Desktop (Windows & Linux AppImage)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # --- TRABAJO PARA WINDOWS (Funciona bien) ---
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar Dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt6 reportlab requests flask qrcode xlsxwriter

    - name: Generar EXE
      run: |
        pyinstaller --noconsole --onefile --name=MantPro_PC --icon=icono.png main.py

    - name: Subir EXE
      uses: actions/upload-artifact@v4
      with:
        name: MantPro-Windows-EXE
        path: dist/MantPro_PC.exe

  # --- TRABAJO PARA LINUX (Corregido para CI sin FUSE) ---
  build-linux:
    runs-on: ubuntu-22.04 # Versión estable y compatible

    steps:
    - uses: actions/checkout@v4

    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar librerías del sistema
      # Instalamos libfuse2 por si acaso, aunque usaremos el método de extracción
      run: |
        sudo apt-get update
        sudo apt-get install -y libfuse2 file

    - name: Instalar Dependencias Python
      run: |
        pip install pyinstaller
        pip install PyQt6 reportlab requests flask qrcode xlsxwriter

    - name: Generar Binario (PyInstaller)
      run: |
        pyinstaller --noconsole --onefile --name=MantPro_Linux --icon=icono.png main.py

    - name: Preparar AppDir
      run: |
        # 1. Crear estructura
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

        # 2. Copiar binario e icono
        cp dist/MantPro_Linux AppDir/usr/bin/mantpro
        cp icono.png AppDir/mantpro.png
        cp icono.png AppDir/.DirIcon

        # 3. Crear .desktop
        cat > AppDir/mantpro.desktop <<EOF
        [Desktop Entry]
        Type=Application
        Name=MantPro
        Exec=mantpro
        Icon=mantpro
        Categories=Utility;
        Terminal=false
        EOF

        # 4. Crear AppRun (Script de arranque)
        cat > AppDir/AppRun <<EOF
        #!/bin/sh
        SELF=\$(readlink -f "\$0")
        HERE=\${SELF%/*}
        export PATH="\${HERE}/usr/bin:\${PATH}"
        export LD_LIBRARY_PATH="\${HERE}/usr/lib:\${LD_LIBRARY_PATH}"
        exec "\${HERE}/usr/bin/mantpro" "\$@"
        EOF
        chmod +x AppDir/AppRun

    - name: Crear AppImage (Método seguro sin FUSE)
      env:
        ARCH: x86_64
      run: |
        # 1. Descargar la versión 'continuous' (más moderna)
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

        # 2. EXTRAER la herramienta (El truco para que funcione en GitHub Actions)
        ./appimagetool-x86_64.AppImage --appimage-extract

        # 3. Usar la herramienta extraída para crear NUESTRA AppImage
        # Usamos squashfs-root/AppRun en lugar del binario AppImage directo
        ./squashfs-root/AppRun AppDir MantPro-Linux-x86_64.AppImage

    - name: Subir AppImage
      uses: actions/upload-artifact@v4
      with:
        name: MantPro-Linux-AppImage
        path: MantPro-Linux-x86_64.AppImage
