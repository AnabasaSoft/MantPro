name: Construir Desktop (Windows, Linux Binario & AppImage)

on:
  push:
    #branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ------------------------------------------------------------------
  # JOB 1: WINDOWS (.exe)
  # ------------------------------------------------------------------
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar Dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt6 reportlab requests flask qrcode xlsxwriter

    - name: Generar EXE
      run: |
        pyinstaller --noconsole --onefile --name=MantPro_WIN --icon=icono.png main.py

    - name: Subir EXE (Artefacto)
      uses: actions/upload-artifact@v4
      with:
        name: MantPro-Windows-EXE
        path: dist/MantPro_WIN.exe

    - name: Publicar EXE en Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/MantPro_WIN.exe

  # ------------------------------------------------------------------
  # JOB 2: LINUX (Binario + AppImage)
  # ------------------------------------------------------------------
  build-linux:
    runs-on: ubuntu-22.04 # Usamos una versión estable para maximizar compatibilidad glibc

    steps:
    - uses: actions/checkout@v4

    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar librerías del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y libfuse2 file build-essential

    - name: Instalar Dependencias Python
      run: |
        pip install pyinstaller
        pip install PyQt6 reportlab requests flask qrcode xlsxwriter

    # --- PASO 1: GENERAR BINARIO STANDALONE ---
    - name: Generar Binario Linux
      run: |
        # Genera el archivo ejecutable en dist/MantPro_Linux
        pyinstaller --noconfirm --onefile --windowed --icon=icono.png --add-data "icono.png:." --name "MantPro_Linux" main.py

    # --- PASO 2: SUBIR BINARIO SUELTO ---
    - name: Subir Binario Linux (Artefacto)
      uses: actions/upload-artifact@v4
      with:
        name: MantPro-Linux-Binario
        path: dist/MantPro_Linux

    # --- PASO 3: PREPARAR APPIMAGE ---
    - name: Preparar AppDir
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

        # Copiamos el binario que acabamos de generar
        cp dist/MantPro_Linux AppDir/usr/bin/mantpro

        cp icono.png AppDir/mantpro.png
        cp icono.png AppDir/.DirIcon

        cat > AppDir/mantpro.desktop <<EOF
        [Desktop Entry]
        Type=Application
        Name=MantPro
        Exec=mantpro
        Icon=mantpro
        Categories=Utility;
        Terminal=false
        EOF

        cat > AppDir/AppRun <<EOF
        #!/bin/sh
        SELF=\$(readlink -f "\$0")
        HERE=\${SELF%/*}
        export PATH="\${HERE}/usr/bin:\${PATH}"
        export LD_LIBRARY_PATH="\${HERE}/usr/lib:\${LD_LIBRARY_PATH}"
        exec "\${HERE}/usr/bin/mantpro" "\$@"
        EOF
        chmod +x AppDir/AppRun

    # --- PASO 4: EMPAQUETAR APPIMAGE ---
    - name: Crear AppImage
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        ./appimagetool-x86_64.AppImage --appimage-extract

        # Generar el AppImage final
        ./squashfs-root/AppRun AppDir MantPro-Linux-x86_64.AppImage

    - name: Subir AppImage (Artefacto)
      uses: actions/upload-artifact@v4
      with:
        name: MantPro-Linux-AppImage
        path: MantPro-Linux-x86_64.AppImage

    # --- PASO 5: PUBLICAR AMBOS EN RELEASE ---
    - name: Publicar Linux en Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/MantPro_Linux
          MantPro-Linux-x86_64.AppImage
