name: Construir Desktop (Windows & Linux AppImage)

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ] # Se activa también al subir etiquetas como v1.0, v1.1...
  workflow_dispatch:

permissions:
  contents: write # Necesario para poder crear Releases

jobs:
  # --- TRABAJO PARA WINDOWS ---
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar Dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt6 reportlab requests flask qrcode xlsxwriter

    - name: Generar EXE
      run: |
        pyinstaller --noconsole --onefile --name=MantPro_PC --icon=icono.png main.py

    - name: Subir EXE como Artefacto (Siempre)
      uses: actions/upload-artifact@v4
      with:
        name: MantPro-Windows-EXE
        path: dist/MantPro_PC.exe

    - name: Publicar en Release (Solo si hay Tag)
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/MantPro_PC.exe

  # --- TRABAJO PARA LINUX ---
  build-linux:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4

    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar librerías sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y libfuse2 file

    - name: Instalar Dependencias Python
      run: |
        pip install pyinstaller
        pip install PyQt6 reportlab requests flask qrcode xlsxwriter

    - name: Generar Binario
      run: |
        pyinstaller --noconsole --onefile --name=MantPro_Linux --icon=icono.png main.py

    - name: Preparar AppDir
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp dist/MantPro_Linux AppDir/usr/bin/mantpro
        cp icono.png AppDir/mantpro.png
        cp icono.png AppDir/.DirIcon
        cat > AppDir/mantpro.desktop <<EOF
        [Desktop Entry]
        Type=Application
        Name=MantPro
        Exec=mantpro
        Icon=mantpro
        Categories=Utility;
        Terminal=false
        EOF
        cat > AppDir/AppRun <<EOF
        #!/bin/sh
        SELF=\$(readlink -f "\$0")
        HERE=\${SELF%/*}
        export PATH="\${HERE}/usr/bin:\${PATH}"
        export LD_LIBRARY_PATH="\${HERE}/usr/lib:\${LD_LIBRARY_PATH}"
        exec "\${HERE}/usr/bin/mantpro" "\$@"
        EOF
        chmod +x AppDir/AppRun

    - name: Crear AppImage
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        ./appimagetool-x86_64.AppImage --appimage-extract
        ./squashfs-root/AppRun AppDir MantPro-Linux-x86_64.AppImage

    - name: Subir AppImage como Artefacto (Siempre)
      uses: actions/upload-artifact@v4
      with:
        name: MantPro-Linux-AppImage
        path: MantPro-Linux-x86_64.AppImage

    - name: Publicar en Release (Solo si hay Tag)
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: MantPro-Linux-x86_64.AppImage
